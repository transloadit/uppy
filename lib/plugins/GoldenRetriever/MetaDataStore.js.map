{"version":3,"sources":["../../../src/plugins/GoldenRetriever/MetaDataStore.js"],"names":["findUppyInstances","instances","i","localStorage","length","key","test","push","slice","maybeParse","str","JSON","parse","err","cleanedUp","module","exports","opts","expires","name","storeName","MetaDataStore","cleanup","load","savedState","getItem","data","metadata","save","Date","now","state","stringify","setItem","instanceIDs","forEach","id","obj","removeItem"],"mappings":";;;;;;AAAA;;;AAGA,SAASA,iBAAT,GAA8B;AAC5B,MAAMC,YAAY,EAAlB;AACA,OAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIC,aAAaC,MAAjC,EAAyCF,GAAzC,EAA8C;AAC5C,QAAMG,MAAMF,aAAaE,GAAb,CAAiBH,CAAjB,CAAZ;AACA,QAAI,cAAcI,IAAd,CAAmBD,GAAnB,CAAJ,EAA6B;AAC3BJ,gBAAUM,IAAV,CAAeF,IAAIG,KAAJ,CAAU,aAAaJ,MAAvB,CAAf;AACD;AACF;AACD,SAAOH,SAAP;AACD;;AAED;;;AAGA,SAASQ,UAAT,CAAqBC,GAArB,EAA0B;AACxB,MAAI;AACF,WAAOC,KAAKC,KAAL,CAAWF,GAAX,CAAP;AACD,GAFD,CAEE,OAAOG,GAAP,EAAY;AACZ,WAAO,IAAP;AACD;AACF;;AAED,IAAIC,YAAY,KAAhB;AACAC,OAAOC,OAAP;AACE,yBAAaC,IAAb,EAAmB;AAAA;;AACjB,SAAKA,IAAL,GAAY,SAAc;AACxBC,eAAS,KAAK,EAAL,GAAU,EAAV,GAAe,IADA,CACK;AADL,KAAd,EAETD,IAFS,CAAZ;AAGA,SAAKE,IAAL,kBAAyBF,KAAKG,SAA9B;;AAEA,QAAI,CAACN,SAAL,EAAgB;AACdA,kBAAY,IAAZ;AACAO,oBAAcC,OAAd;AACD;AACF;;AAED;;;;;AAbF,0BAgBEC,IAhBF,mBAgBU;AACN,QAAMC,aAAarB,aAAasB,OAAb,CAAqB,KAAKN,IAA1B,CAAnB;AACA,QAAI,CAACK,UAAL,EAAiB,OAAO,IAAP;AACjB,QAAME,OAAOjB,WAAWe,UAAX,CAAb;AACA,QAAI,CAACE,IAAL,EAAW,OAAO,IAAP;;AAEX;AACA;AACA,QAAI,CAACA,KAAKC,QAAV,EAAoB;AAClB,WAAKC,IAAL,CAAUF,IAAV;AACA,aAAOA,IAAP;AACD;;AAED,WAAOA,KAAKC,QAAZ;AACD,GA9BH;;AAAA,0BAgCEC,IAhCF,iBAgCQD,QAhCR,EAgCkB;AACd,QAAMT,UAAUW,KAAKC,GAAL,KAAa,KAAKb,IAAL,CAAUC,OAAvC;AACA,QAAMa,QAAQpB,KAAKqB,SAAL,CAAe;AAC3BL,wBAD2B;AAE3BT;AAF2B,KAAf,CAAd;AAIAf,iBAAa8B,OAAb,CAAqB,KAAKd,IAA1B,EAAgCY,KAAhC;AACD,GAvCH;;AAyCE;;;;;AAzCF,gBA4CST,OA5CT,sBA4CoB;AAChB,QAAMY,cAAclC,mBAApB;AACA,QAAM8B,MAAMD,KAAKC,GAAL,EAAZ;AACAI,gBAAYC,OAAZ,CAAoB,UAACC,EAAD,EAAQ;AAC1B,UAAMV,OAAOvB,aAAasB,OAAb,gBAAkCW,EAAlC,CAAb;AACA,UAAI,CAACV,IAAL,EAAW,OAAO,IAAP;AACX,UAAMW,MAAM5B,WAAWiB,IAAX,CAAZ;AACA,UAAI,CAACW,GAAL,EAAU,OAAO,IAAP;;AAEV,UAAIA,IAAInB,OAAJ,IAAemB,IAAInB,OAAJ,GAAcY,GAAjC,EAAsC;AACpC3B,qBAAamC,UAAb,gBAAqCF,EAArC;AACD;AACF,KATD;AAUD,GAzDH;;AAAA;AAAA","file":"MetaDataStore.js","sourcesContent":["/**\n * Get uppy instance IDs for which state is stored.\n */\nfunction findUppyInstances () {\n  const instances = []\n  for (let i = 0; i < localStorage.length; i++) {\n    const key = localStorage.key(i)\n    if (/^uppyState:/.test(key)) {\n      instances.push(key.slice('uppyState:'.length))\n    }\n  }\n  return instances\n}\n\n/**\n * Try to JSON-parse a string, return null on failure.\n */\nfunction maybeParse (str) {\n  try {\n    return JSON.parse(str)\n  } catch (err) {\n    return null\n  }\n}\n\nlet cleanedUp = false\nmodule.exports = class MetaDataStore {\n  constructor (opts) {\n    this.opts = Object.assign({\n      expires: 24 * 60 * 60 * 1000 // 24 hours\n    }, opts)\n    this.name = `uppyState:${opts.storeName}`\n\n    if (!cleanedUp) {\n      cleanedUp = true\n      MetaDataStore.cleanup()\n    }\n  }\n\n  /**\n   *\n   */\n  load () {\n    const savedState = localStorage.getItem(this.name)\n    if (!savedState) return null\n    const data = maybeParse(savedState)\n    if (!data) return null\n\n    // Upgrade pre-0.20.0 uppyState: it used to be just a flat object,\n    // without `expires`.\n    if (!data.metadata) {\n      this.save(data)\n      return data\n    }\n\n    return data.metadata\n  }\n\n  save (metadata) {\n    const expires = Date.now() + this.opts.expires\n    const state = JSON.stringify({\n      metadata,\n      expires\n    })\n    localStorage.setItem(this.name, state)\n  }\n\n  /**\n   * Remove all expired state.\n   */\n  static cleanup () {\n    const instanceIDs = findUppyInstances()\n    const now = Date.now()\n    instanceIDs.forEach((id) => {\n      const data = localStorage.getItem(`uppyState:${id}`)\n      if (!data) return null\n      const obj = maybeParse(data)\n      if (!obj) return null\n\n      if (obj.expires && obj.expires < now) {\n        localStorage.removeItem(`uppyState:${id}`)\n      }\n    })\n  }\n}\n"]}